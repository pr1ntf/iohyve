#!/bin/sh

# iohyve v0.7.5 2016/04/14 "Tennessee Cherry Moonshine Edition"

# Set proper path thanks to iocage
PATH=${PATH}:/bin:/usr/bin:/usr/local/bin:/sbin:/usr/sbin:/usr/local/sbin

# Check if libs are available (stolen from iocage)
if [ -e "./lib/ioh-cmd" ] ; then
    LIB="./lib"
elif [ -e "/usr/local/lib/iohyve" ] ; then
    LIB="/usr/local/lib/iohyve"
else
    echo "ERROR: missing libraries"
    exit 1
fi

. "${LIB}/ioh-cmd"
. "${LIB}/ioh-setup"
. "${LIB}/ioh-zfs"
. "${LIB}/ioh-console"

# Show version
__version() {
	echo "iohyve v0.7.5 2016/04/14 Tennessee Cherry Moonshine Edition"
}

__get_bhyve_cmd() {
	local devices="$1"
	local pci_slot_count=0
	for device in $devices ; do
		echo "-s $pci_slot_count,$device"
		pci_slot_count=$(( pci_slot_count + 1 ))
	done
}

# Get PCI device config from zfs
__get_zfs_pcidev_conf() {
	local pool="$1"
	local oldifs=$IFS
	#local pci
	IFS=$'\n'
	for pcidev in $(zfs get -H -o property,value all $pool | grep iohyve:pcidev: | sort )
	do
		echo $pcidev | cut -f2-
	done
	IFS=$oldifs
}

# List Guests
__list() {
	local pools="$(zfs list -H | grep iohyve | cut -d '/' -f 1 | uniq )"
	(
	printf "%s^%s^%s^%s^%s\n" "Guest" "VMM?" "Running" "rcboot?" "Description"
	for pool in $pools; do
	local guests="$(zfs list -H | grep -i ^$pool/iohyve | grep -Ev "disk|ISO|Firmware" | cut -f1 | cut -d'/' -f3 | sed 1d | uniq)"
		for g in $guests; do
			local vmm="/dev/vmm/ioh-$g"
			if [ -e $vmm ]; then
				vmm="YES"
			else
				vmm="NO"
			fi
			local running=$(pgrep -fx "bhyve: ioh-$g")
			if [ -z $running ]; then
				running="NO"
			else
				running="YES"
			fi
			local boot="$(zfs get -H -o value iohyve:boot $pool/iohyve/$g)"
			if [ $boot = '1' ]; then
				boot="YES"
			else
				boot="NO"
			fi
		local description="$(zfs get -H -o value iohyve:description $pool/iohyve/$g)"
		printf "%s^%s^%s^%s^%s\n" "$g" "$vmm" "$running" "$boot" "$description"
		done
	done
	) | column -ts^
}

# Display info about all guests.
__info() {
	dflag="$2"
	if [ -z $dflag ]; then
		(printf 'Name\tSize\tRAM\tCPU\tOS\tLoader\n';  \
			zfs list -H -o name,volsize,iohyve:ram,iohyve:cpu,iohyve:os,iohyve:loader | \
			grep iohyve | grep -Ev "ISO|Firmware"  |  cut -d '/' -f3- | sed 1d) | column -t
	elif [ $dflag = "-d" ]; then
		(printf 'Name\tSize\tRAM\tCPU\tOS\tLoader\tDescription\n';  \
			zfs list -H -o name,volsize,iohyve:ram,iohyve:cpu,iohyve:os,iohyve:loader,iohyve:description | \
			grep iohyve | grep -Ev "ISO|Firmware"  |  cut -d '/' -f3- | sed 1d) | column -t
	else
		echo "Usage: $0 $1 [-d]"
	fi
}

# List iso's
__isolist() {
	echo "Listing ISO's..."
	zfs list -H | grep iohyve/ISO/ | cut -f 1 | cut -d '/' -f 4
}

# List Firmware
__fwlist() {
	echo "Listing Firmware..."
	zfs list -H | grep iohyve/Firmware/ | cut -f1 | cut -d '/' -f 4
}

# Fetch ISO
__fetchiso() {
	if [ -z $2 ]; then
		echo "Usage: $0 $1 <url>"
		return
	fi
	local url="$2"
	local pool="$(zfs list -H | grep iohyve | cut -d '/' -f 1 | head -n1)"
	local name="$(basename $2)"
	echo "Fetching $url..."
	zfs create $pool/iohyve/ISO/$name
	fetch $url -o /iohyve/ISO/$name
}

# Copy ISO from local machine
__cpiso() {
	if [ -z $2 ]; then
		echo "Usage: $0 $1 <path>"
		return
	fi
	local loc="$2"
	local pool="$(zfs list -H | grep iohyve | cut -d '/' -f 1 | head -n1)"
	local name="$(basename $loc)"
	echo "Copying $name from $loc..."
	zfs create $pool/iohyve/ISO/$name
	cp $loc /iohyve/ISO/$name
}

# Rename an ISO
__renameiso() {
	if [ -z $2 ] || [ -z $3 ]; then
		echo "Usage: $0 $1 <oldname> <newname>"
		return
	fi
	local pool="$(zfs list -H | grep iohyve | cut -d '/' -f 1 | head -n1)"
	local iso="$2"
	local name="$3"

	if ! zfs list -H -o name $pool/iohyve/ISO/$iso > /dev/null 2>&1; then
	#if [ ! -d /iohyve/ISO/$iso ]; then
		echo "cannot rename '$2': iso does not exist"
		return
	fi
	echo "Renaming ISO $2 to $3..."
	mv /iohyve/ISO/$iso/$iso /iohyve/ISO/$iso/$name
	zfs rename $pool/iohyve/ISO/$iso $pool/iohyve/ISO/$name
}

# Delete ISO
__deleteiso() {
	if [ -z $2 ];then
		echo "Usage: $0 $1 <iso>"
		return
	fi
	local name="$2"
	local pool="$(zfs list -H | grep iohyve | cut -d '/' -f 1 | head -n1)"
	if ! zfs list -H -o name $pool/iohyve/ISO/$name > /dev/null 2>&1; then
		echo "cannot remove '$2': iso does not exist"
		return
	fi
	echo "Deleting $name..."
	zfs destroy -rR $pool/iohyve/ISO/$name
}

# Fetch Firmware
__fetchfw() {
	if [ -z $2 ]; then
		echo "Usage: $0 $1 <url>"
		return
	fi
	local url="$2"
	local pool="$(zfs list -H | grep iohyve | cut -d '/' -f 1 | head -n1)"
	local name="$(basename $2)"
	if zfs list -H -o name $pool/iohyve/Firmware/$name > /dev/null 2>&1; then
		echo "cannot fetch '$name': firmware already exists"
		return
	fi
	echo "Fetching $url..."
	zfs create $pool/iohyve/Firmware/$name
	fetch $url -o /iohyve/Firmware/$name
}

# Copy Firmware from local machine
__cpfw() {
	if [ -z $2 ]; then
		echo "Usage: $0 $1 <name>"
		return
	fi
	local loc="$2"
	local pool="$(zfs list -H | grep iohyve | cut -d '/' -f 1 | head -n1)"
	local name="$(basename $loc)"
	if [ ! -d $loc ]; then
		echo "cannot copy '$loc': firmware does not exist"
		return
	fi
	echo "Copying $name from $loc..."
	zfs create $pool/iohyve/Firmware/$name
	cp $loc /iohyve/Firmware/$name
}

# Rename Firmware
__renamefw() {
	if [ -z $2 ] || [ -z $3 ]; then
		echo "Usage: $0 $1 <oldname> <newname>"
		return
	fi
	local pool="$(zfs list -H | grep iohyve | cut -d '/' -f 1 | head -n1)"
	local fw="$2"
	local name="$3"
	if ! zfs list -H -o name $pool/iohyve/Firmware/$fw > /dev/null 2>&1; then
		echo "cannot rename '$2': firmware does not exist"
		return
	fi
	echo "Renaming Firmware $2 to $3..."
	mv /iohyve/Firmware/$fw/$fw /iohyve/Firmware/$fw/$name
	zfs rename $pool/iohyve/Firmware/$fw $pool/iohyve/Firmware/$name
}

# Delete Firmware
__deletefw() {
	if [ -z $2 ]; then
		echo "Usage $0 $1 <name>"
		return
	fi
	local name="$2"
	local pool="$(zfs list -H | grep iohyve | cut -d '/' -f 1 | head -n1)"
	if ! zfs list -H -o name $pool/iohyve/Firmware/$name > /dev/null 2>&1; then
		echo "cannot delete '$2': firmware does not exist"
		return
	fi
	echo "Deleting $name..."
	zfs destroy -rR $pool/iohyve/Firmware/$name
}

# Create guest
__create() {
	if [ -z $2 ] || [ -z $3 ]; then
		echo "Usage $0 $1 <name> <size>"
		return
	fi
	local name="$2"
	local pool="${4-$(zfs list -H | grep iohyve | cut -d '/' -f 1 | head -n1)}"
	if zfs list -H -o name $pool/iohyve/$name > /dev/null 2>&1; then
		echo "cannot create '$name': guest already exists"
		return
	fi
	local size="$3"
	local description="$(date)"
	local guestlist="$(zfs list -H -o name -t volume | grep iohyve | cut -d'/' -f1-3)"
	listtaps(){
		for i in $guestlist ; do
			local tapprop="$(zfs get -H -o value iohyve:tap $i)"
			printf $tapprop'\n'
		done
	}
	local taplast="$(listtaps | sort -V | cut -c4- | tail -n1)"
	if [ -z $taplast ]; then
		local tap='0'
	else
		local tap="$(expr $taplast + 1)"
	fi
	listcons(){
		for i in $guestlist ; do
			local conprop="$(zfs get -H -o value iohyve:con $i)"
			printf $conprop'\n'
		done
	}
	local conlast="$(listcons | sort -V | cut -c5- | tail -n1)"
	if [ -z $conlast ]; then
		local con='0'
	else
		local con="$(expr $conlast + 1)"
	fi
	echo "Creating $name..."
	zfs create $pool/iohyve/$name
	zfs create -V $size -o volmode=dev $pool/iohyve/$name/disk0
	zfs set iohyve:name=$name $pool/iohyve/$name
	zfs set iohyve:size=$size $pool/iohyve/$name
	zfs set iohyve:ram=256M $pool/iohyve/$name
	zfs set iohyve:cpu=1 $pool/iohyve/$name
	zfs set iohyve:tap=tap$tap $pool/iohyve/$name
	zfs set iohyve:con=nmdm$con $pool/iohyve/$name
	zfs set iohyve:persist=1 $pool/iohyve/$name
	zfs set iohyve:boot=0 $pool/iohyve/$name
	zfs set iohyve:loader=bhyveload $pool/iohyve/$name
	zfs set iohyve:os=default $pool/iohyve/$name
	zfs set "iohyve:description=$description" $pool/iohyve/$name
	zfs set iohyve:bargs=-A_-H_-P $pool/iohyve/$name
}

# Install guest
__install() {
	if [ -z $2 ] || [ -z $3 ]; then
		echo "Usage $0 $1 <name> <iso>"
		return
	fi
	local name="$2"
	local iso="$3"
	local pool="$(zfs list -H -t volume -o name | grep $name | grep disk0 | cut -d '/' -f1)"
	local dataset="$(zfs list -H -t volume | grep $name | cut -d '/' -f 1-3 | head -n1)"
	# Check if guest exists
	if [ -d /iohyve/$pool/$name ] || [ -d /iohyve/$name ]; then
		# Check to make sure guest isn't running
		local running=$(pgrep -fx "bhyve: ioh-$name")
		if [ -z $running ]; then
			local ram="$(zfs get -H -o value iohyve:ram $dataset)"
			local con="$(zfs get -H -o value iohyve:con $dataset)"
			local cpu="$(zfs get -H -o value iohyve:cpu $dataset)"
			local bargexist="$(zfs get -H -o value iohyve:bargs $dataset)"
			local bargs="$(echo $bargexist | sed -e 's/_/ /g')"
			echo "Installing $name..."
			# Set install prop
			zfs set iohyve:install=yes $pool/iohyve/$name
			# Load from CD
			__load "$name" "/iohyve/ISO/$iso/$iso"
			# Prepare and start guest
			pci="$(__prepare_guest $name) ahci-cd,/iohyve/ISO/$iso/$iso"
			local pci_args=$(__get_bhyve_cmd "$pci" )
			bhyve -c $cpu $bargs -m $ram $pci_args -lcom1,/dev/${con}A ioh-$name &
		else
			echo "$name is already running."
		fi
	else
		echo "cannot install '$name': guest does not exist"
	fi
}

# Load guest
__load() {
	if [ -z $1 ] || [ -z $2 ]; then
		echo "Usage: $0 load <name> <path-to-bootdisk>"
		return
	fi
	local name="$1"
	local media="$2"
	local disk="${3-$(zfs list -H -t volume -o name | grep $name | grep disk0 | head -n1)}"
	local dataset="$(zfs list -H -t volume -o name | grep $name | grep disk0 | cut -d '/' -f 1-3 | head -n1)"
	local ram="$(zfs get -H -o value iohyve:ram $dataset)"
	local con="$(zfs get -H -o value iohyve:con $dataset)"
	local loader="$(zfs get -H -o value iohyve:loader $dataset)"
	local install="$(zfs get -H -o value iohyve:install $dataset)"
	local os="$(zfs get -H -o value iohyve:os $dataset)"
	local autogrub="$(zfs get -H -o value iohyve:autogrub $dataset)"
	local bargexist="$(zfs get -H -o value iohyve:bargs $dataset)"
	local bargs="$(echo $bargexist | sed -e 's/_/ /g')"
	#Testing if -S is in the bargs settings. If then pass -S to bhyveload.
	local test_for_wire_memory="-S"
	case $bargs in
		*${test_for_wire_memory}*) local wire_memory="-S" ;;
		*) local wire_memory="" ;;
	esac
	if [ $loader = "grub-bhyve" ]; then
		if [ $install = "yes" ]; then
			if [ $os = "openbsd59" ]; then
				printf '\(hd0\)\ /dev/zvol/'$disk'\n' > /iohyve/$name/device.map
				printf '\(cd0\)\ '$media'\n' >> /iohyve/$name/device.map
				printf 'kopenbsd -h com0 (cd0)/5.9/amd64/bsd.rd\nboot\n' > /iohyve/$name/grub.cfg
				grub-bhyve $wire_memory -m /iohyve/$name/device.map -r host -d /iohyve/$name -c /dev/${con}A -M $ram ioh-$name
			elif [ $os = "openbsd58" ]; then
				printf '\(hd0\)\ /dev/zvol/'$disk'\n' > /iohyve/$name/device.map
				printf '\(cd0\)\ '$media'\n' >> /iohyve/$name/device.map
				printf 'kopenbsd -h com0 (cd0)/5.8/amd64/bsd.rd\nboot\n' > /iohyve/$name/grub.cfg
				grub-bhyve $wire_memory -m /iohyve/$name/device.map -r host -d /iohyve/$name -c /dev/${con}A -M $ram ioh-$name
			elif [ $os = "openbsd57" ]; then
				printf '\(hd0\)\ /dev/zvol/'$disk'\n' > /iohyve/$name/device.map
				printf '\(cd0\)\ '$media'\n' >> /iohyve/$name/device.map
				printf 'kopenbsd -h com0 (cd0)/5.7/amd64/bsd.rd\nboot\n' > /iohyve/$name/grub.cfg
				grub-bhyve $wire_memory -m /iohyve/$name/device.map -r host -d /iohyve/$name -c /dev/${con}A -M $ram ioh-$name
			elif [ $os = "netbsd" ]; then
				printf '\(hd0\)\ /dev/zvol/'$disk'\n' > /iohyve/$name/device.map
				printf '\(cd0\)\ '$media'\n' >> /iohyve/$name/device.map
				printf 'knetbsd -h -r cd0a (cd0)/netbsd\nboot\n' > /iohyve/$name/grub.cfg
				grub-bhyve $wire_memory -m /iohyve/$name/device.map -r host -d /iohyve/$name -c /dev/${con}A -M $ram ioh-$name
			elif [ $os = "debian" ]; then
				printf '\(hd0\)\ /dev/zvol/'$disk'\n' > /iohyve/$name/device.map
				printf '\(cd0\)\ '$media'\n' >> /iohyve/$name/device.map
				grub-bhyve $wire_memory-m /iohyve/$name/device.map -r cd0  -c /dev/${con}A -M $ram ioh-$name
			elif [ $os = "d8lvm" ]; then
				printf '\(hd0\)\ /dev/zvol/'$disk'\n' > /iohyve/$name/device.map
				printf '\(cd0\)\ '$media'\n' >> /iohyve/$name/device.map
				grub-bhyve $wire_memory -m /iohyve/$name/device.map -r cd0 -c /dev/${con}A -M $ram ioh-$name
			elif [ $os = "centos6" ] || [ $os = "centos7" ]; then
				printf '\(hd0\)\ /dev/zvol/'$disk'\n' > /iohyve/$name/device.map
				printf '\(cd0\)\ '$media'\n' >> /iohyve/$name/device.map
				printf 'linux (cd0)/isolinux/vmlinuz\ninitrd (cd0)/isolinux/initrd.img\nboot\n' > /iohyve/$name/grub.cfg
				grub-bhyve $wire_memory -m /iohyve/$name/device.map -r host -d /iohyve/$name -c /dev/${con}A -M $ram ioh-$name
			elif [ $os = "arch" ]; then
				printf '\(hd0\)\ /dev/zvol/'$disk'\n' > /iohyve/$name/device.map
				printf '\(cd0\)\ '$media'\n' >> /iohyve/$name/device.map
				printf 'linux (cd0)/arch/boot/x86_64/vmlinuz archisobasedir=arch archisolabel=ARCH_'$(date +%Y%m)' ro\ninitrd (cd0)/arch/boot/x86_64/archiso.img\nboot\n' > /iohyve/$name/grub.cfg
				grub-bhyve $wire_memory -m /iohyve/$name/device.map -r host -d /iohyve/$name -c /dev/${con}A -M $ram ioh-$name
			elif [ $os = "custom" ]; then
				grub-bhyve $wire_memory -m /iohyve/$name/device.map -r host -d /iohyve/$name -c /dev/${con}A -M $ram ioh-$name
			else
				printf '\(hd0\)\ /dev/zvol/'$disk'\n' > /iohyve/$name/device.map
				printf '\(cd0\)\ '$media'\n' >> /iohyve/$name/device.map
				grub-bhyve $wire_memory -m /iohyve/$name/device.map -r cd0 -c /dev/${con}A -M $ram ioh-$name
			fi
		elif [ $install = "no" ]; then
			if [ $os = "openbsd59" ]; then
				printf '\(hd0\)\ /dev/zvol/'$disk'\n' > /iohyve/$name/device.map
				printf '\(cd0\)\ '$media'\n' >> /iohyve/$name/device.map
				printf 'kopenbsd -h com0 -r sd0a (hd0,openbsd1)/bsd\nboot\n' > /iohyve/$name/grub.cfg
				grub-bhyve $wire_memory -m /iohyve/$name/device.map -r host -d /iohyve/$name -c /dev/${con}A -M $ram ioh-$name
			elif [ $os = "openbsd58" ]; then
				printf '\(hd0\)\ /dev/zvol/'$disk'\n' > /iohyve/$name/device.map
				printf '\(cd0\)\ '$media'\n' >> /iohyve/$name/device.map
				printf 'kopenbsd -h com0 -r sd0a (hd0,openbsd1)/bsd\nboot\n' > /iohyve/$name/grub.cfg
				grub-bhyve $wire_memory -m /iohyve/$name/device.map -r host -d /iohyve/$name -c /dev/${con}A -M $ram ioh-$name
			elif [ $os = "openbsd57" ]; then
				printf '\(hd0\)\ /dev/zvol/'$disk'\n' > /iohyve/$name/device.map
				printf '\(cd0\)\ '$media'\n' >> /iohyve/$name/device.map
				printf 'kopenbsd -h com0 -r sd0a (hd0,openbsd1)/bsd\nboot\n' > /iohyve/$name/grub.cfg
				grub-bhyve $wire_memory -m /iohyve/$name/device.map -r host -d /iohyve/$name -c /dev/${con}A -M $ram ioh-$name
			elif [ $os = "netbsd" ]; then
				printf '\(hd0\)\ /dev/zvol/'$disk'\n' > /iohyve/$name/device.map
				printf '\(cd0\)\ '$media'\n' >> /iohyve/$name/device.map
				printf 'knetbsd -h -r wd0a (hd0,msdos1)/netbsd\nboot\n' > /iohyve/$name/grub.cfg
				grub-bhyve $wire_memory -m /iohyve/$name/device.map -r host -d /iohyve/$name -c /dev/${con}A -M $ram ioh-$name
			elif [ $os = "debian" ]; then
				printf '\(hd0\)\ /dev/zvol/'$disk'\n' > /iohyve/$name/device.map
				printf '\(cd0\)\ '$media'\n' >> /iohyve/$name/device.map
				grub-bhyve $wire_memory -m /iohyve/$name/device.map -r hd0,msdos1 -c /dev/${con}A -M $ram ioh-$name
			elif [ $os = "d8lvm" ]; then
				printf '\(hd0\)\ /dev/zvol/'$disk'\n' > /iohyve/$name/device.map
				printf '\(cd0\)\ '$media'\n' >> /iohyve/$name/device.map
				grub-bhyve $wire_memory -m /iohyve/$name/device.map -r hd0,msdos1 -d /grub -c /dev/${con}A -M $ram ioh-$name
			elif [ $os = "centos6" ]; then
				printf '\(hd0\)\ /dev/zvol/'$disk'\n' > /iohyve/$name/device.map
				printf '\(cd0\)\ '$media'\n' >> /iohyve/$name/device.map
				grub-bhyve $wire_memory -m /iohyve/$name/device.map -r hd0,msdos1 -d /grub -c /dev/${con}A -M $ram ioh-$name
			elif [ $os = "centos7" ]; then
				printf '\(hd0\)\ /dev/zvol/'$disk'\n' > /iohyve/$name/device.map
				printf '\(cd0\)\ '$media'\n' >> /iohyve/$name/device.map
				grub-bhyve $wire_memory -m /iohyve/$name/device.map -r hd0,msdos1 -d /grub2 -c /dev/${con}A -M $ram ioh-$name
			elif [ $os = "custom" ]; then
				grub-bhyve $wire_memory -m /iohyve/$name/device.map -r host -d /iohyve/$name -c /dev/${con}A -M $ram ioh-$name
			else
				printf '\(hd0\)\ /dev/zvol/'$disk'\n' > /iohyve/$name/device.map
				printf '\(cd0\)\ '$media'\n' >> /iohyve/$name/device.map
				grub-bhyve $wire_memory -m /iohyve/$name/device.map -r hd0,msdos1 -c /dev/${con}A -M $ram ioh-$name
			fi
		fi
	else
		bhyveload $wire_memory -m $ram -d $media -c /dev/${con}A ioh-$name
	fi
}

# Boot guest
__boot() {
	if [ -z $1 ]; then
		echo "Usage $0 boot <name> [runmode] [pcidevices]"
		return
	fi
	local name="$1"
	# runmode (runonce/persist)
	#   0 = once
	#   1 = persist regular (stop if guest is powering off)
	#   2 = always persist (start again even if guest is powering off)
	local runmode="$2"
	local pci="$3"
	local dataset="$(zfs list -H -t volume | grep $name | grep disk0 | cut -d '/' -f 1-3 | head -n1)"
	if [ -z $dataset ]; then
		echo "cannot boot '$name': guest does not exist"
		return
	fi
	local ram="$(zfs get -H -o value iohyve:ram $dataset)"
	local con="$(zfs get -H -o value iohyve:con $dataset)"
	local cpu="$(zfs get -H -o value iohyve:cpu $dataset)"
	local persist="$(zfs get -H -o value iohyve:persist $dataset)"
	local bargexist="$(zfs get -H -o value iohyve:bargs $dataset)"
	local bargs="$(echo $bargexist | sed -e 's/_/ /g')"
	# Set install prop
	zfs set iohyve:install=no $dataset
	# Generate list of bhyve -s commands for all devices
	local pci_args=$(__get_bhyve_cmd "$pci" )
	# Handle the starting of the guest inside a spawned subshell so the guest
	# can be restarted automatically if the guest reboots or crashes
	local runstate="1"
	(
		while [ $runstate = "1" ]
		do
			__load "$name" "/dev/zvol/$dataset/disk0"
			bhyve -c $cpu $bargs -m $ram $pci_args -lcom1,/dev/${con}A ioh-$name &
			local vmpid=$!
			wait $vmpid
			vmrc=$?
			sleep 5
			if [ $runmode == "0" ]; then
				runstate="0"
			elif [ $vmrc == "1" ] && [ $runmode != 2 ]; then
				# VM has been powered off
				runstate="0"
			else
				if [ $(zfs get -H -o value iohyve:persist $dataset) != 1 ]; then
					runstate="0"
				fi
			fi
		done
		bhyvectl --destroy --vm=ioh-$name
		# Resetting the flag so that a vm which we stopped by abusing zfs set/get
		# as as an IPC mechanism is persistent again next time we start it
		if [ ! -z $persist ]; then
			zfs set iohyve:persist="$persist" $dataset
		fi
	) &
}

__prepare_guest() {
	local name="$1"
	local dataset="$(zfs list -H -t volume | grep $name | grep disk0 | cut -d '/' -f 1-3 | head -n1)"
	local pci="$(__get_zfs_pcidev_conf $dataset)"
	# Setup tap if needed
	local listtap="$(zfs get -H -o value iohyve:tap $dataset)"
	for tap in $(echo $listtap | sed -n 1'p' | tr ',' '\n'); do
		if [ $tap ] && [ $tap != "-" ]; then
			local tapif="$(ifconfig -l | tr ' ' '\n' | grep -F -w $tap)"
			if [ -z $tapif ]; then
				# create tap interface
				ifconfig $tap create descr "iohyve-$name"
				ifconfig bridge0 addm $tap
			fi
			# Add a virtio-net pci device for the tap
			local mac="$(zfs get -H -o value iohyve:mac_$tap $dataset)"
			if [ $mac = "-" ]; then
				pci="$pci virtio-net,$tap"
			else
				pci="$pci virtio-net,${tap},mac=${mac}"
			fi
		fi
        done
	#Add disk as second PCI device
	pci="ahci-hd,/dev/zvol/$dataset/disk0 $pci"
	#Add Hostbridge and lpc as the first PCI devices
	pci="hostbridge lpc $pci"
	# return the list of pci devices
	echo $pci
}

# Start guest (combine load and boot)
__start() {
	if [ -z $2 ]; then
		echo "Usage: $0 $1 <name> [-s | -a]"
		return 1
	fi
	local name="$2"
	local flag="$3"
	local pci=""
	local runmode="1"
	local pool="$(zfs list -H -t volume -o name | grep $name| grep disk0 | cut -d '/' -f1)"
	local dataset="$(zfs list -H -t volume -o name | grep $name | grep disk0 | cut -d '/' -f 1-3 | head -n1)"
	local loader="$(zfs get -H -o value iohyve:loader $dataset)"

	if ! zfs list -H -o name $pool/iohyve/$name > /dev/null 2>&1; then
		echo "cannot start '$name': guest does not exists"
		return
	fi

	# Check if loader is UEFI
	if [ $loader = "uefi" ]; then
		__uefi "$name" "null.iso"
	fi
	# Check if guest exists
	if [ -d /iohyve/$pool/$name ] || [ -d /iohyve/$name ]; then
		# Check to make sure guest isn't running
		local running=$(pgrep -fx "bhyve: ioh-$name")
		if [ -z $running ]; then
			case "$flag" in
				-s)	runmode="0"	# single - start only once
					;;
				-a) 	runmode="2"	# always - persist regardless what
					;;
				*)	runmode="1"	# persist - persists until guest is powering off
					;;
			esac
			echo "Starting $name... (Takes 15 seconds for FreeBSD guests)"
			# Prepare and boot guest
			pci="$(__prepare_guest $name)"
			__boot "$name" "$runmode" "$pci"
		else
			echo "$name is already running."
		fi
	else
		echo "Not a valid guest name"
	fi
}

# Start a UEFI enabled bhyve instance.
# This is experimental, use with caution.
__uefi() {
	if [ -z $2 ] || [ -z $3 ]; then
		echo "Usage: $0 $1 <name> <iso>"
		return 1
	fi
	local name="$2"
	local media="$3"
	local dataset="$(zfs list -H -t volume | grep $name | cut -d '/' -f 1-3 | head -n1)"
	if [ -z $dataset ]; then
		echo "cannot start '$name': guest does not exists"
		return 1
	fi
	local ram="$(zfs get -H -o value iohyve:ram $dataset)"
	local con="$(zfs get -H -o value iohyve:con $dataset)"
	local cpu="$(zfs get -H -o value iohyve:cpu $dataset)"
	local fw="$(zfs get -H -o value iohyve:fw $dataset)"
	local tap="$(zfs get -H -o value iohyve:tap $dataset)"
	local bargs="$(zfs get -H -o value iohyve:bargs $dataset | sed -e 's/_/ /g')"
	local pool="$(zfs list -H -t volume -o name | grep $name | cut -d '/' -f1)"
	# Create tap if needed
	# check to see if tap is already created before attempting to create new tap interface
	local tapif="$(ifconfig -l | tr ' ' '\n' | grep -F -w $tap)"
	if [ -z $tapif ]; then
		# create tap interface
		ifconfig $tap create descr "iohyve-$name"
		ifconfig bridge0 addm $tap
	fi
	# Make sure everything is in order...
	if [ $fw = '-' ]; then
		echo "cannot start '$name': firmware has to be set for uefi boot"
		return 1
	fi
	#if [ -z $media ]; then
	#	echo "You must enter at least a zero byte ISO for some OSs..."
	#	echo "EX: iohyve uefi winguest null.iso"
	#fi
	# Check if guest exists
	if [ -d /iohyve/$pool/$name ] || [ -d /iohyve/$name ]; then
		# Check to make sure guest isn't running
		local running=$(pgrep -fx "bhyve: ioh-$name")
		if [ -z $running ]; then
			# The good stuff...
			bhyve -c $cpu $bargs -m $ram \
			        -s 0,hostbridge \
			        -s 3,ahci-cd,/iohyve/ISO/$media/$media \
			        -s 4,ahci-hd,/dev/zvol/$dataset/disk0,sectorsize=512 \
			        -s 10,virtio-net,$tap \
			        -s 31,lpc \
			        -l com1,/dev/${con}A \
			        -l bootrom,/iohyve/Firmware/$fw/$fw \
			        ioh-$name &
		else
			echo "cannot start '$name': guest is already running"
		fi
	else
		echo "cannot start '$name': guest does not exist"
	fi
}

# Gracefully stop a guest
__stop() {
	if [ -z $2 ]; then
		echo "Usage: $0 $1 <name>"
		return 1
	fi
	local name="$2"
	local pool="$(zfs list -H | grep iohyve | cut -d '/' -f 1 | head -n1)"
	local pid=$(pgrep -fx "bhyve: ioh-$name")
#	zfs set iohyve:persist=0 $pool/iohyve/$name
	if [ -z $pid ]; then
		echo "cannot stop '$name': guest is not running"
	else
		printf "stopping $name: "
		kill $pid
		printf "done\n"
	fi
#	sleep 20
#	bhyvectl --destroy --vm=ioh-$name
}

# Force kill -9 everyting matching $name and destroy
# THIS WILL KILL EVERYTHING MATCHING $NAME
__forcekill() {
	if [ -z $2 ]; then
		echo "Usage: $0 $1 <name>"
		return 1
	fi
	local name="$2"
	local pids="$(pgrep -f $name)"
	for apid in "$pids"; do
		kill -9 $apid
	done
	bhyvectl --destroy --vm=ioh-$name
}

# Gracefully shut down all guests via ACPI (Does not destroy)
__scram() {
	echo "shutting down all guests: "
	local pids="$(pgrep -f ioh-)"
	local procs="$(pgrep -l -f ioh-)"
	for proc in "$procs"; do
		local pid="$(pgrep -l -f ioh- | cut -f1 -d' ')"
		local name="$(pgrep -l -f ioh- | cut -f2 -d-)"
		printf "shutting '$name' down: "
		kill $pid
		printf "done\n"
	done
	#local pids="$(pgrep -f ioh-)"
	#for apid in "$pids"; do
	#	kill $apid
	#done
	#wait_for_pids $pids # Error: /usr/local/sbin/iohyve: wait_for_pids: not found
}

# Destroy guest
__destroy() {
	if [ -z $2 ]; then
		echo "Usage: $0 $1 <name>"
		return 1
	fi
	local name="$2"
	local pool="$(zfs list -H | grep iohyve | cut -d '/' -f 1 | head -n1)"
	printf "destroying '$name': "
#	zfs set iohyve:persist=0 $pool/iohyve/$name
	bhyvectl --force-poweroff --vm=ioh-$name
	bhyvectl --destroy --vm=ioh-$name
	printf "done\n"
}

# Rename the guest
__rename() {
	if [ -z $2 ] || [ -z $3 ]; then
		echo "Usage $0 $1 <name> <newname>"
		return 1
	fi
	local name="$2"
	local newname="$3"
	local pool="$(zfs list -H -t volume | grep $name | cut -d '/' -f 1 | head -n1)"
	if ! zfs list -H -o name $pool/iohyve/$name > /dev/null 2>&1; then
		echo "cannot rename '$name': guest does not exist"
		return
	fi
	printf "renaming '$name' to '$newname': "
	zfs rename -f $pool/iohyve/$name $pool/iohyve/$newname
	zfs set iohyve:name=$newname $pool/iohyve/$newname
	printf "done\n"
}

# Delete guest
__delete() {
	local flagone="$2"
	local flagtwo="$3"
	if [ $flagone = "-f" ]; then
		if [ -z $flagtwo ]; then
			echo "Usage $0 $1 [-d] <name>"
			return 1
		fi
		local target_dataset="$(zfs list -H -t filesystem -o name | grep iohyve | grep -v "/ISO/" | grep -v "Firmware" | grep $flagtwo | head -n1)"
		if [ -z $target_dataset ]; then
			echo "cannot delete '$flagtwo': guest does not exist"
			return
		fi
		echo ""
		echo "[WARNING] Forcing permanent deletion of $flagtwo"
		echo "Location: $target_dataset including children and clones"
		echo ""
		echo "Hit Ctrl+C in the next 10 seconds to cancel..."
		sleep 10
		echo "Deleting $flagtwo at $target_dataset..."
		zfs destroy -rR $target_dataset
	else
		if [ -z $flagone ]; then
			echo "Usage $0 $1 [-d] <name>"
			return
		fi
		local target_dataset="$(zfs list -H -t filesystem -o name | grep iohyve | grep -v "/ISO/" | grep -v "Firmware" | grep $flagone | head -n1)"
		if [ -z $target_dataset ]; then
			echo "cannot delete '$flagone': guest does not exist"
			return
		fi
		echo ""
		echo "[WARNING] Are you sure you want to permanently delete $flagone and all child datasets?"
		read -p "Location: $target_dataset [y/N]? " an </dev/tty
		case "$an" in
			y|Y) printf "deleting '$flagone' ($target_dataset): "; zfs destroy -r $target_dataset; printf "done\n"
 			;;
			*) echo "did not delete '$flagone': user canceled deletion"
		esac
	fi
}

# Set ZFS properties
__set() {
	if [ -z $2 ]; then
		echo "Usage $0 $1 <name>"
		return 1
	fi
	local name="$2"
	local pool="$(zfs list -H -t volume | grep $name | cut -d '/' -f 1 | head -n1)"
	shift 2
	for arg in "$@"; do
		local prop="$(echo $arg | cut -d '=' -f1)"
		local val="$(echo $arg | cut -d '=' -f2)"

		local prev="$(zfs get -H -o value iohyve:$prop $pool/iohyve/$name)"
		if [ $prop = "bargs" ]; then
			local sval="$(echo $val | cut -d '"' -f2 | sed -e 's/ /_/g')"
			#echo "Setting $name $prop=$val..."
			zfs set iohyve:$prop=$sval $pool/iohyve/$name
			echo "$name.$prop: $prev -> $sval"
		elif [ $prop = "description" ]; then
			local sval="$(echo $val | cut -d '"' -f2)"
			#echo "Setting $name $prop=$val..."
			zfs set "iohyve:$prop=$sval" $pool/iohyve/$name
			echo "$name.$prop: $prev -> $sval"
		else
			#echo "Setting $name $prop=$val..."
			zfs set iohyve:$prop=$val $pool/iohyve/$name
			echo "$name.$prop: $prev -> $val"
		fi
	done
}

# Get ZFS props
__get() {
	if [ -z $2 ] || [ -z $3 ]; then
		echo "Usage: $0 $1 <name> <prop>"
		return 1
	fi
	local name="$2"
	local prop="$3"
	local pool="$(zfs list -H -t volume | grep $name | cut -d '/' -f 1 | head -n1)"
	if ! zfs list -H -o name $pool/iohyve/$name > /dev/null 2>&1; then
		echo "cannot get '$name.$prop': guest does not exist"
		return
	fi
	printf "$name.$prop: "
	zfs get -H -o value iohyve:$prop $pool/iohyve/$name
}

# Remove a PCIDEV property
__rmpci() {
	local flagone="$2"
	local flagtwo="$3"
	local flagthree="$4"
	if [ "$flagone" = "-f" ]; then
		if [ -z $flagtwo ] || [ -z $flagthree ]; then
			echo "Usage: $0 $1 [-f] <name> <pcidev:N>"
			return 1
		fi
		echo "Removing $flagthree from $flagtwo"
		local pciprop="$(echo "$flagthree" | grep pcidev:)"
		local pool="$(zfs list -H -t volume | grep $flagtwo | cut -d '/' -f 1 | head -n1)"
		# Make sure it's a valid pcidev property as to not shoot foot
		if [ -z $pciprop ]; then
			echo "cannot remove '$flagthree': unvalid PCIDEV property"
		else
			zfs inherit  -r iohyve:$flagthree $pool/iohyve/$flagtwo
		fi
	else
		if [ -z $flagone ] || [ -z $flagtwo ]; then
			echo "Usage: $0 $1 [-f] <name> <pcidev:N>"
			return 1
		fi
		local pciprop="$(echo "$flagtwo" | grep pcidev:)"
		local pool="$(zfs list -H -t volume | grep $flagone | cut -d '/' -f 1 | head -n1)"
		# Make sure it's a valid pcidev property as to not shoot foot
		if [ -z $pciprop ]; then
			echo "cannot remove '$flagtwo': unvalid PCIDEV property"
		else
			read -p "Are you sure you want to remove $flagtwo [y/N]? " an </dev/tty
			case "$an" in
				y|Y) zfs inherit  -r iohyve:$flagtwo $pool/iohyve/$flagone
				;;
				*) echo "did not remove: user canceled removal"
				;;
			esac
		fi
	fi
}

# Get all ZFS props
__getall() {
	if [ -z $2 ]; then
		echo "Usage: $0 $1 <name>"
		return 1
	fi
	local name="$2"
	local pool="$(zfs list -H -t volume | grep iohyve/$name | grep disk0 | cut -d '/' -f 1 | head -n1)"
	if ! zfs list -H -o name $pool/iohyve/$name > /dev/null 2>&1; then
		echo "cannot get properties of '$name': guest does not exist"
		return 1
	fi
	printf "PROPERTY\tVALUE\n"
	zfs get -o property,value all $pool/iohyve/$name | grep iohyve: | sort | sed -e 's/iohyve://g'
}

# Add a new disk to guest
__add() {
	if [ -z $2 ] || [ -z $3 ]; then
		echo "Usage: $0 $1 <name> <size> [pool]"
		return 1
	fi
	local name="$2"
	local size="$3"
	local pool="$(zfs list -H -t volume | grep $name | cut -d '/' -f 1 | head -n1)"
	# optionally allow the pool for the new disk to be specified. If not set, its set to $pool
	local newpool="${4-$pool}"
	# Find the last disk number and increment one
	local lastdisk="$(zfs list -H | grep $name | grep disk | cut -d '/' -f4 | cut -f1 | \
		sort -V | cut -c5- | tail -n1)"
	local newdisk="$(expr $lastdisk + 1)"
	printf "creating zvol of size $size for $name: "
	zfs create $newpool/iohyve/$name 2> /dev/null
	zfs create -V $size -o volmode=dev $newpool/iohyve/$name/disk$newdisk
	# Find the last pcidev and increment by one
	local lastpci="$(zfs get -H all | grep iohyve/$name | grep pcidev | cut -f2 | \
		cut -d ':' -f3 | sort -V | tail -n1)"
	if [ -z $lastpci ]; then
		local newpci='1'
	else
		local newpci="$(expr $lastpci + 1)"
	fi
	zfs set iohyve:pcidev:$newpci=ahci-hd,/dev/zvol/$newpool/iohyve/$name/disk$newdisk $pool/iohyve/$name
	printf "done\n"
}

# Remove disk from guest
__remove() {
	local flagone="$2"
	local flagtwo="$3"
	local flagthree="$4"
	if [ $flagone = "-f" ]; then
		if [ -z $flagtwo ] || [ -z $flagthree ]; then
			echo "Usage: $0 $1 [-f] <name> <diskN>"
			return
		fi
		local pool="$(zfs list -H -o name | grep $flagtwo | grep $flagthree | cut -d '/' -f 1)"
		if ! zfs list -H -o name $pool/iohyve/$flagtwo/$flagthree > /dev/null 2>&1; then
			echo "cannot remove disk '$flagthree' from '$flagtwo': disk does not exist"
			return
		fi
		printf "removing $flagthree from $flagtwo: "
		local pciprop="$(zfs get -H all $pool/iohyve/$flagtwo | grep pcidev | grep $flagthree | cut -f2 )"
		# Make sure it's a valid pcidev property as to not shoot foot
		if [ -z $pciprop ]; then
			printf "failed: unvalid PCIDEV property '$pciprop'\n"
		else
			zfs inherit  -r $pciprop $pool/iohyve/$flagtwo
			zfs destroy $pool/iohyve/$flagtwo/$flagthree
			printf "done\n"
		fi
	else
		if [ -z $flagone ] || [ -z $flagtwo ]; then
			echo "Usage: $0 $1 [-f] <name> <diskN>"
			return
		fi
		local pool="$(zfs list -H -o name | grep $flagone | grep $flagtwo | cut -d '/' -f 1)"
		if ! zfs list -H -o name $pool/iohyve/$flagone/$flagtwo > /dev/null 2>&1; then
			echo "cannot remove disk '$flagtwo' from '$flagone': disk does not exist"
			return
		fi
		local pciprop="$(zfs get -H all $pool/iohyve/$flagone | grep pcidev | grep $flagtwo | cut -f2 )"
		# Make sure it's a valid pcidev property as to not shoot foot
		if [ -z $pciprop ]; then
			echo "cannot remove guest: unvalid PCIDEV property '$pciprop'"
		else
			read -p "Are you sure you want to remove $flagtwo from $flagone [y/N]? " an </dev/tty
			case "$an" in
				y|Y)	printf "removing $flagtwo from $flagone: "
					zfs inherit  -r $pciprop $pool/iohyve/$flagone
					zfs destroy $pool/iohyve/$flagone/$flagtwo
					printf "done\n"
				;;
				*) echo "did not remove: user canceled removal"
				;;
			esac
		fi
	fi
}

# Resize a disk
__resize(){
	if [ -z $2 ] || [ -z $3 ] || [ -z $4 ]; then
		echo "Usage: $0 $1 <name> <diskN> <newsize>"
		return 1
	fi
	local name="$2"
	local disk="$3"
	local size="$4"
	local pool="$(zfs list -H -o name | grep $name | grep $disk | cut -d '/' -f 1)"
	if ! zfs list -H -o name $pool/iohyve/$name/$disk > /dev/null 2>&1; then
		echo "cannot resize disk '$name/$disk': disk does not exist"
		return
	fi
	# Check if guest exists
	if [ -d /iohyve/$pool/$name ] || [ -d /iohyve/$name ]; then
		# Check to make sure guest isn't running
		local running=$(pgrep -fx "bhyve: ioh-$name")
		if [ -z $running ]; then
			local prev="$(zfs get -H -o value volsize $pool/iohyve/$name/$disk)"
			zfs set volsize=$size $pool/iohyve/$name/$disk
			zfs set iohyve:size=$size $pool/iohyve/$name
			echo "$name.$disk: $prev -> $size"
		else
			echo "cannot resize disk: guest is running"
		fi
	else
		echo "cannot resize disk: guest does not exist"
	fi
}

# List disks for a guest
__disks() {
	local name="$2"
	local pool="$(zfs list -H | grep iohyve | cut -d '/' -f 1 | head -n1)"
	if [ -z $name ]; then
		echo "Usage: $0 $1 <name>"
	elif [ -d /iohyve/$pool/$name ] || [ -d /iohyve/$name ]; then
		(
		printf "DISK\tSIZE\n"
		zfs list -H -o name,volsize | grep -E "iohyve.*$name.*disk" | \
			cut -d '/' -f4
		) | column -t
	else
		echo "Not a valid guest name"
	fi
}



# Export Guest
__exportguest() {
	if [ -z $2 ]; then
		"Usage: $0 $1 <name>"
		return 1
	fi
	local name="$2"
	local pool="$(zfs list -H -t volume | grep $name | grep disk0 | cut -d '/' -f 1 | head -n1)"
	local disklist="$(zfs list -H | grep iohyve | grep $name | grep disk | \
				cut -f1 | cut -d '/' -f4-)"
	# Check if guest exists
	echo "Exporting $name. Note this may take some time depending on the size."
	if [ -d /iohyve/$pool/$name ] || [ -d /iohyve/$name ]; then
		# Check to make sure guest isn't running
		local running=$(pgrep -fx "bhyve: ioh-$name")
		if [ -z $running ]; then
			# Create /tmp/iohyve/$name
			echo "Creating temp directory..."
			mkdir -p /tmp/iohyve/$name
			# Export Properties to file
			echo "Exporting properties..."
			zfs get -H -o property,value all $pool/iohyve/$name | grep iohyve: | sort | \
				sed -e 's/iohyve://g' | sed -e 's/	/=/g' > /tmp/iohyve/$name/properties.ucl
			# Write disks to file
			echo "Exporting disks..."
			for disk in $disklist ; do
				dd if=/dev/zvol/$pool/iohyve/$name/$disk of=/tmp/iohyve/$name/${disk}.img bs=1M
			done
			# Compress and add to archive
			echo "Compressing to archive..."
			tar -czf /iohyve/$name/$name.tar.gz -C /tmp/iohyve/$name/ .
			# Remove /tmp/iohyve/
			echo "Removing temp directory..."
			rm -fr /tmp/iohyve
		else
			echo "cannot export '$name': guest still running"
		fi
	else
		echo "cannot export '$name': guest does not exist"
		return 1
	fi
}

# List all the snapshots
__snaplist() {
	(
	printf "%s^%s\n" "GUEST" "SNAPSHOT"
	local snapshotguests="$(zfs list -H -t snap | grep /iohyve/ | grep -v disk | cut -f1 | cut -d '/' -f3 | cut -d '@' -f1 | uniq)"

	for guest in $snapshotguests; do
		local snapshots="$(zfs list -H -t snap | grep /iohyve/ | grep $guest@ | grep -v disk | cut -f1 | cut -d '/' -f3)"
		local first="$(echo $snapshot | head -1)"
		local rest="$(echo $snapshot | tail -1)"
		printf "%s^%s\n" "$guest" "$first"
		for snap in $rest; do
			printf "%s^%s\n" "" "$snap"
		done
	done
	) | column -ts^
}

# List taps in use
__taplist() {
	local guestlist="$(zfs list -H -o name -t volume | grep iohyve | cut -d'/' -f1-3)"
	printf "GUEST\tTAPDEVICE\n"
	for i in $guestlist ; do
		conprop="$(zfs get -H -o value iohyve:tap $i)"
		printf "$i\t$conprop\n"
	done
}

# List active taps in use
__activetaps() {
  echo "Listing active network taps..."
	ls /dev | grep tap
}


# Print help page
__help() {
cat << 'EOT'
iohyve  version
	setup pool=[poolname] kmod=[0/1] net=[interface]
	list
	info [-d]
	isolist
	fwlist
	fetchiso <URL>
	cpiso <path>
	renameiso <oldname> <newname>
	rmiso <ISO>
	fetchfw <URL>
	cpfw <path>
	renamefw <firmware> <newname>
	rmfw <firmware>
	create <name> <size>
	install <name> <iso>
	load <name> <path/to/bootdisk>
	boot <name> [runmode] [pcidevices]
	start <name> [-s | -a]
	stop <name>
	forcekill <name>
	scram
	destroy <name>
	rename <name> <newname>
	delete [-f] <name>
	set <name> [prop1=value] [prop2=value]...
	get <name> <prop>
	rmpci [-f] <name> <pcidev:N>
	getall <name>
	add <name> <size> [pool]
	remove [-f] <name> <diskN>
	resize <name> <diskN> <size>
	disks <name>
	snap <name>@<snapshotname>
	roll <name>@<snapshotname>
	clone [-c | -r] <name> <clonename>
	export <name>
	snaplist
	taplist
	activetaps
	conlist
	console <name>
	conreset
	help
EOT
}

if [ -z "$1" ] ; then
	__help
	exit 0
fi

if [ $(__readonly_cmd "$1") != "0" -a "$(whoami)" != "root" ] ; then
	echo "The $1 command needs root credentials!"
	exit 1
fi

__parse_cmd "$@"
